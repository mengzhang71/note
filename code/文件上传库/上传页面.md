```
<template>
  <div class="dynamic">
    <div class="content">
      <div class="top">
        <div class="top-left">
          <div class="title">{{ title }}资料</div>
        </div>
        <el-button class="release" @click="handleRelease">发布</el-button>
      </div>
      <div class="left">
        <div class="sub-title">基本信息表</div>
        <el-form
          :model="form"
          :rules="rules"
          label-position="top"
          ref="FormRef"
          label-width="100px"
          class="dynamic-form"
        >
          <el-form-item label="标题：" prop="title">
            <el-input v-model="form.title"></el-input>
          </el-form-item>
          <el-form-item class="tag-form-item" label="标签：" prop="tagIds">
            <div class="tag-form-item-label" slot="label">
              <span>标签：</span>
              <el-button
                class="add-btn"
                type="text"
                :icon="nodeList.length ? 'el-icon-edit' : 'el-icon-plus'"
                @click="handleAddLabel"
                >{{ nodeList.length ? '编辑' : '新增' }}</el-button
              >
            </div>
            <div class="label-wrapper">
              <div class="label-item ellipsis" v-for="item in nodeList" :key="item.id">
                {{ item.name }}
                <el-button @click="handleDeleteTag(item)" type="text" icon="el-icon-close"></el-button>
              </div>
            </div>
            <LabelListDialog ref="LabelListDialogRef" @tags="handleSetTags"></LabelListDialog>
          </el-form-item>
          <el-form-item label="附件：" prop="region" class="upload-item">
            <el-upload
              action=""
              accept=".pdf,.jpg,.png,.jpeg,.doc,.docx,.txt,.xls,.xlsx,.wps,.ofd"
              :file-list="form.files"
              :http-request="handleUpload"
              :on-success="handleSuccess"
              class="file-upload"
              :class="{ empty: !form.files.length }"
              multiple
            >
              <div class="upload-trigger">
                <span class="upload-icon"></span>
                上传文件,请<el-button size="small" type="text">点击上传 </el-button>
              </div>
              <div slot="file" slot-scope="{ file }" class="custom-file-item" @click="handlePreview(file)">
                <svg-icon class="icon-size-16" :icon-class="fileIcon(file.name)" />
                <span class="file-name ellipsis">{{ file.name }}</span>
                <span class="status">
                  <i class="el-icon-success"></i>
                  上传成功
                </span>
                <el-button
                  type="text"
                  class="del-btn"
                  icon="el-icon-delete"
                  @click.stop.prevent="handleBeforeRemove(file)"
                ></el-button>
              </div>
            </el-upload>
          </el-form-item>
        </el-form>
      </div>
    </div>
    <FilePreview
      :visible.sync="previewShow"
      :customAuth="customAuth"
      :previewOptions="previewOptions"
      :hasCustomAuth="true"
      :apiOptions="apiOptions"
    ></FilePreview>
  </div>
</template>
<script lang="ts">
import { Vue, Component, Ref } from 'vue-property-decorator'
import FilePreview from '@/components/FilePreview/FilePreview.vue'
import LabelListDialog from '@/modules/subsystem/cloud/components/LabelListDialog.vue'
import comService from '@/modules/subsystem/Program/api/comService'
import { getJobDetail, getTagsTree, importJobAdd, jobUpdate } from '@/modules/subsystem/cloud/api/index'
import { UserModule } from '@/store/modules/user'
import { recursionTree } from '@/utils/util'
import { UploaderClass } from '@/utils/uploader/index.js'
import { fileUploadChunk, fileUploadExists } from '@/api/file'
@Component({
  components: { FilePreview, LabelListDialog }
})
export default class Dynamic extends Vue {
  @Ref() FormRef!: any
  @Ref() LabelListDialogRef!: any
  private form: any = {
    content: '',
    files: [],
    id: '',
    tagIds: [],
    title: ''
  }
  private rules = {
    title: [{ required: true, message: '请输入', trigger: 'blur' }],
    tagIds: [{ required: true, message: '请选择', trigger: 'change' }]
  }
  apiOptions: any = {
    storeId: '',
    moduleKey: ''
  }
  customAuth: any = {}
  previewOptions: any = {}
  previewShow = false
  private tagsData: any[] = []
  private nodeList: any[] = []
  private signature: any = {}
  private isEdit = false
  get userName() {
    return UserModule.userInfo.user.userName
  }
  get title() {
    return this.isEdit ? '编辑' : '新增'
  }
  get fileIcon() {
    return (name: any) => {
      const icon = this.$XxFileIcon(name)
      // 这个库里写了个bug
      if (icon === 'icc-files-unknow') return 'icc-files-unkown'
      return icon
    }
  }
  created() {
    console.log(this.$XxFileIcon('abc.wps'))
    const params = this.$xxTab.getArgs()
    if (params.id) {
      getJobDetail({ id: params.id }).then((res: any) => {
        this.form = res.data
        // !note 保存到后台的数据 和 拉取详情的数据不一样
        this.form.files = (res.data.fileList || []).map((item: any) => ({ ...item, name: item.fileName }))
        this.form.tagIds = (res.data.tags || '').split(/,?\|/).filter(Boolean)
        this.initTagTree()
      })
      this.isEdit = true
    } else {
      this.isEdit = false
    }
  }
  initTagTree() {
    getTagsTree().then((res: any) => {
      const treeData = res.data || []
      this.tagsData = treeData
      if (this.form.tagIds.length) {
        let list: any = []
        recursionTree(treeData, (node: any) => {
          if (this.form.tagIds.includes(node.id)) {
            list.push(node)
          }
        })
        this.nodeList = list
      }
    })
  }
  // 获取签名
  getSignature() {
    comService.getSignature({ storeId: 'op' }).then(res => {
      this.signature = res.data
      const { filePermissionVo, signature } = res.data
      this.customAuth = Object.freeze({ signature, filePermissionVo })
    })
  }
  // 上传文件
  handleUpload(params: any) {
    this.upload(params)
  }
  upload(params: any) {
    const { signature, filePermissionVo } = this.signature
    const data = {
      basePath: `/DYNAMIC/`,
      storeId: 'op',
      ...{ signature, filePermissionVo }
    }
    const uploaderClass = new UploaderClass({
      files: [params.file],
      beforeUpload: () => data,
      fileExists: fileUploadExists,
      uploadChunk: fileUploadChunk
    })
    console.log(params, 'params')
    console.log(data, 'data')
    console.log(uploaderClass, 'uploaderClass')
    // debugger
    uploaderClass
      .start()
      .then((res: any) => {
        this.handleSuccess(res[0])
      })
      .catch((e: any) => {
        params.onError(e, params)
      })
  }
  handleSuccess(res: any) {
    const { fileName, linkGuid } = res
    console.log(JSON.stringify(this.form.files, null, 2))
    const hasUploaded = this.form.files.find((item: any) => item.fileLinkId === linkGuid)
    console.log(linkGuid, fileName)
    if (!hasUploaded) {
      this.form.files.push({
        fileLinkId: linkGuid,
        fileName,
        name: fileName
      })
    }
  }
  handleBeforeRemove(item: any) {
    this.$confirm(`是否删除【${item.fileName}】标签?`, '提示', {
      confirmButtonText: '确定',
      cancelButtonText: '取消',
      type: 'warning'
    }).then(() => {
      this.handleRemove(item)
    })
  }
  handleRemove(item: any) {
    this.form.files = this.form.files.filter((cur: any) => cur.fileLinkId !== item.fileLinkId)
  }

  handlePreview(file: any) {
    // 编辑情况
    /*
    {
      "id": "801921787776889251",
      "cloudJobId": null,
      "fileLinkId": "391876789739646976",
      "fileName": "屏幕截图 2022-08-08 152029.png",
      "name": "屏幕截图 2022-08-08 152029.png",
      "uid": 1684373389114,
      "status": "success"
    }
    */
    // 新增情况
    /*
   {
      "fileLinkId": "391884738100916224",
      "fileName": "2.xls",
      "name": "2.xls",
      "uid": 1684373455095,
      "status": "success"
    }
   */
    this.apiOptions = { storeId: 'op', moduleKey: '' }
    this.previewOptions = {
      id: file.fileLinkId,
      title: file.fileName
    }
    this.previewShow = true
  }
  handleAddLabel() {
    let tags = this.form.tagIds
    console.log(tags)
    if (!tags.length) tags = null
    this.LabelListDialogRef.show(tags)
  }

  handleSetTags({ nodeIds, nodeList }: any) {
    this.form.tagIds = nodeIds
    this.nodeList = nodeList
  }
  handleRelease() {
    this.FormRef.validate().then(() => {
      let req: any
      if (this.isEdit) {
        req = jobUpdate(this.form)
      } else {
        req = importJobAdd(this.form)
      }
      req.then(() => {
        this.$message.success(`${this.title}资料上传成功`)
        this.$xxTab.close()
        this.$xxTab.open('subSystem-cloud', '重点工作动态一览', {})
      })
    })
  }
  handleDeleteTag(item: any) {
    console.log(this.nodeList, '=====================')
    this.nodeList = this.nodeList.filter((it: any) => it.id !== item.id)
    this.form.tagIds = this.nodeList.map((it: any) => it.id)
  }
}
</script>
<style lang="scss" scoped>
.dynamic {
  height: 100%;
  display: flex;
  flex-direction: column;
  background: url('~@/assets/images/cloud/edit-bg.png') center center no-repeat;
  .top {
    width: 785px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    .release {
      background-color: #24c2b0;
      color: #fff;
    }
  }
  .sub-title {
    color: #000000;
    font-size: 16px;
    font-weight: 600;
    padding: 25px;
  }
  .content {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    .left {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      width: 785px;
      height: 702px;
      opacity: 1;
      border: 1px solid #d9d9d9ff;
      background: #ffffffff;
      box-shadow: 0 6px 20px 0 #a0bee036;
    }
    .right {
      flex: 1;
      height: 100%;
      border-top: 1px solid #f6f5f8;
    }
  }
}
.title {
  color: #007d79;
  font-size: 20px;
  display: flex;
  align-items: center;
  position: relative;
  height: 100%;
  padding-left: 40px;
  &::before {
    content: '';
    position: absolute;
    background: url('~@/assets/images/cloud/dynamic/title-logo.png');
    background-repeat: no-repeat;
    background-position: right bottom;
    background-size: 100% 100%;
    top: 50%;
    transform: translateY(-50%);
    width: 24px;
    height: 24px;
    left: 0px;
  }
}
.dynamic-form.el-form {
  padding: 15px 50px;
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  .el-select {
    width: 100%;
  }
  .add-btn {
    color: #24c2b0;
  }
}
.text-ipt {
  width: 100%;
  height: 100%;
  box-sizing: border-box;
  padding: 10px;
  outline: none;
  font-size: 16px;
  line-height: 30px;
}
.label-wrapper {
  display: flex;
  flex-wrap: wrap;
  border: 1px solid #d9d9d9;
  border-radius: 4px;
  padding: 10px 0 0 10px;
  min-height: 58px;
  .label-item {
    color: #595959;
    border-radius: 4px;
    padding: 2px 10px;
    margin-right: 10px;
    margin-bottom: 10px;
    border-radius: 14px;
    background: #f0f0f0ff;
  }
}
.file-upload {
  display: flex;
  flex-direction: column;
  overflow: hidden;
  height: 100%;
  border: 1px solid #d9d9d9;
  border-radius: 4px;
  padding: 8px;
  ::v-deep {
    .el-upload-list {
      flex: 1;
      overflow: auto;
    }
  }
  &.empty {
    background-image: url('~@/assets/images/public/gridNoData.png');
    background-repeat: no-repeat;
    background-size: 200px 200px;
    background-position: center center;
  }
}
.el-form-item {
  flex: 0;
  &.upload-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    ::v-deep .el-form-item__content {
      flex: 1;
      overflow: hidden;
    }
  }
  &.tag-form-item {
    ::v-deep {
      .el-form-item__label {
        display: flex;
      }
      .tag-form-item-label {
        display: flex;
        justify-content: space-between;
        width: 100%;
      }
      .el-icon-close {
        color: #595959;
      }
    }
  }
}
/*去除upload组件过渡效果*/
::v-deep .el-upload-list__item {
  transition: none !important;
}
::v-deep .el-upload-list__item-thumbnail {
  /* 图片在方框内显示长边 */
  object-fit: scale-down !important;
}
.upload-trigger {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 30px;
  width: 100%;
  border-radius: 4px;
  border: 1px dashed #d9d9d9ff;
  .upload-icon {
    width: 16px;
    height: 16px;
    display: block;
    background: url('~@/assets/images/cloud/dynamic/upload.png') center center no-repeat;
  }
}
.custom-file-item {
  display: flex;
  align-items: center;
  cursor: pointer;
  .file-name {
    margin-left: 8px;
    flex: 1;
    color: #595959;
  }
  .status {
    color: #595959;
    .el-icon-success {
      color: #15a32b;
    }
  }
  .del-btn {
    margin-left: 20px;
  }
}
</style>

```

